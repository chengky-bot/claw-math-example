<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿«æ¨‚å­¸åŠ æ³• - å¤¾å…¬ä»”æ©Ÿç‰ˆ</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Varela+Round&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif;
            background-color: #FEF9C3; /* soft yellow */
            overflow-x: hidden;
            touch-action: manipulation; /* Disable double-tap zoom */
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Holographic Effect for FAB */
        .holographic {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.4) 100%),
                        linear-gradient(90deg, #ff00cc, #3333ff, #00ccff, #ff00cc);
            background-size: 200% 200%;
            animation: holoGradient 4s ease infinite;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(0, 204, 255, 0.3);
        }

        @keyframes holoGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom Scrollbar for Settings */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 3px;
        }

        /* Animations for Claw */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        
        // --- Icons ---
        const Icons = {
            Settings: () => <i data-lucide="sliders-horizontal"></i>,
            Home: () => <i data-lucide="home"></i>,
            Volume2: () => <i data-lucide="volume-2"></i>,
            VolumeX: () => <i data-lucide="volume-x"></i>,
            Play: () => <i data-lucide="play"></i>,
            ArrowLeft: () => <i data-lucide="arrow-left"></i>,
            Delete: () => <i data-lucide="delete"></i>,
            Check: () => <i data-lucide="check"></i>,
            Coins: () => <i data-lucide="coins"></i>,
            Gift: () => <i data-lucide="gift"></i>,
            User: () => <i data-lucide="user"></i>,
            Star: () => <i data-lucide="star"></i>,
            RefreshCw: () => <i data-lucide="refresh-cw"></i>,
            Turtle: () => <i data-lucide="turtle"></i>,
            Rabbit: () => <i data-lucide="rabbit"></i>,
            Computer: () => <i data-lucide="monitor"></i>
        };

        // --- Utility: TTS ---
        const speak = (text, rate = 1, force = false) => {
            if (!window.speechSynthesis) return;
            // Cancel previous speech if forcing a new one
            if (force) window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-HK'; // Default to Cantonese
            utterance.rate = rate;
            window.speechSynthesis.speak(utterance);
        };

        // --- Components ---

        // 1. Settings Module
        const SettingsModule = ({ settings, setSettings }) => {
            const [isOpen, setIsOpen] = useState(false);

            // Font Sizes mapping (1-6)
            const fontSizes = [14, 16, 18, 22, 26, 32];
            // Speech Rates mapping (1-6)
            const speechRates = [0.5, 0.6, 0.7, 0.8, 0.9, 1.0];

            useEffect(() => {
                lucide.createIcons();
            }, [isOpen]);

            return (
                <>
                    {/* Toggle Button */}
                    <motion.button
                        className="fixed top-4 right-4 z-50 w-12 h-12 bg-blue-500 text-white rounded-xl shadow-lg flex items-center justify-center hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300"
                        whileTap={{ scale: 0.9 }}
                        onClick={() => setIsOpen(!isOpen)}
                        aria-label="åå¥½è¨­å®š"
                    >
                        <Icons.Settings />
                    </motion.button>

                    {/* Drawer */}
                    <AnimatePresence>
                        {isOpen && (
                            <>
                                <motion.div 
                                    className="fixed inset-0 bg-black/20 z-40"
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    onClick={() => setIsOpen(false)}
                                />
                                <motion.div
                                    className="fixed top-20 right-4 w-80 bg-white rounded-2xl shadow-2xl z-50 p-6 border-2 border-blue-100"
                                    initial={{ x: 100, opacity: 0 }}
                                    animate={{ x: 0, opacity: 1 }}
                                    exit={{ x: 100, opacity: 0 }}
                                >
                                    <h3 className="text-xl font-bold text-slate-700 mb-6 flex items-center gap-2">
                                        <Icons.Settings /> è¨­å®š
                                    </h3>

                                    {/* Font Size Control */}
                                    <div className="mb-8">
                                        <div className="flex justify-between mb-2">
                                            <span className="text-slate-600 font-medium">å­—é«”å¤§å°</span>
                                            <span className="text-blue-600 font-bold">{fontSizes[settings.fontSizeIdx]}px</span>
                                        </div>
                                        <input 
                                            type="range" min="0" max="5" step="1"
                                            value={settings.fontSizeIdx}
                                            onChange={(e) => setSettings({...settings, fontSizeIdx: parseInt(e.target.value)})}
                                            className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                        />
                                        <div className="flex justify-between text-xs text-gray-400 mt-1">
                                            <span>å°</span>
                                            <span>å¤§</span>
                                        </div>
                                    </div>

                                    {/* Speech Rate Control */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <span className="text-slate-600 font-medium">èªªè©±é€Ÿåº¦</span>
                                            <span className="text-blue-600 font-bold">{speechRates[settings.speechRateIdx]}x</span>
                                        </div>
                                        <input 
                                            type="range" min="0" max="5" step="1"
                                            value={settings.speechRateIdx}
                                            onChange={(e) => setSettings({...settings, speechRateIdx: parseInt(e.target.value)})}
                                            className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500"
                                        />
                                        <div className="flex justify-between items-center text-gray-500 mt-2">
                                            <div className="flex items-center gap-1"><Icons.Turtle size={16}/> æ…¢</div>
                                            <div className="flex items-center gap-1">å¿« <Icons.Rabbit size={16}/></div>
                                        </div>
                                    </div>

                                    {/* Audio Toggle */}
                                    <div className="mt-8 flex items-center justify-between p-3 bg-blue-50 rounded-xl">
                                        <span className="text-slate-700 font-medium">éŸ³æ•ˆé–‹é—œ</span>
                                        <button 
                                            onClick={() => setSettings({...settings, soundOn: !settings.soundOn})}
                                            className={`w-12 h-7 rounded-full p-1 transition-colors ${settings.soundOn ? 'bg-green-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform ${settings.soundOn ? 'translate-x-5' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>
                </>
            );
        };

        // 2. Custom Keypad (For Input Questions)
        const CustomKeypad = ({ onInput, onDelete, onSubmit, disabled }) => {
            const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
            
            return (
                <div className="grid grid-cols-3 gap-3 max-w-sm mx-auto mt-6">
                    {keys.map(k => (
                        <motion.button
                            key={k}
                            whileTap={{ scale: 0.9 }}
                            onClick={() => onInput(k)}
                            disabled={disabled}
                            className="h-16 bg-white border-2 border-blue-200 rounded-2xl text-2xl font-bold text-slate-700 shadow-[0_4px_0_rgb(219,234,254)] active:shadow-none active:translate-y-1 disabled:opacity-50"
                        >
                            {k}
                        </motion.button>
                    ))}
                    <motion.button
                        whileTap={{ scale: 0.9 }}
                        onClick={onDelete}
                        disabled={disabled}
                        className="h-16 bg-red-100 border-2 border-red-200 rounded-2xl text-red-600 flex items-center justify-center shadow-[0_4px_0_rgb(254,226,226)] active:shadow-none active:translate-y-1 disabled:opacity-50"
                    >
                        <Icons.Delete />
                    </motion.button>
                    <motion.button
                        whileTap={{ scale: 0.9 }}
                        onClick={onSubmit}
                        disabled={disabled}
                        className="h-16 col-span-2 bg-green-500 border-2 border-green-600 rounded-2xl text-white font-bold text-xl flex items-center justify-center gap-2 shadow-[0_4px_0_rgb(22,163,74)] active:shadow-none active:translate-y-1 disabled:opacity-50"
                    >
                        ç¢ºèª <Icons.Check />
                    </motion.button>
                </div>
            );
        };

        // 3. Game Screens
        
        // Welcome Screen
        const WelcomeScreen = ({ onStart, fontSize }) => {
            const [name, setName] = useState("");
            
            return (
                <motion.div 
                    initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }}
                    className="flex flex-col items-center justify-center min-h-[80vh] p-6 text-center"
                >
                    <div className="mb-8 p-6 bg-white/60 rounded-full shadow-xl backdrop-blur-sm animate-float">
                        <span className="text-8xl">ğŸ—ï¸</span>
                    </div>
                    <h1 className="text-blue-600 font-extrabold mb-2" style={{ fontSize: `${fontSize * 1.5}px` }}>å¿«æ¨‚å­¸åŠ æ³•</h1>
                    <p className="text-slate-500 mb-8" style={{ fontSize: `${fontSize}px` }}>æˆ‘å€‘å»å¤¾ç¦®ç‰©çµ¦çˆ¸çˆ¸åª½åª½å§ï¼</p>
                    
                    <div className="w-full max-w-md bg-white p-6 rounded-3xl shadow-xl border-2 border-yellow-200">
                        <label className="block text-left text-slate-600 font-bold mb-2 ml-1" style={{ fontSize: `${fontSize}px` }}>ä½ å«ä»€éº¼åå­—ï¼Ÿ</label>
                        <input 
                            type="text" 
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="ä¾‹å¦‚ï¼šå°æ˜"
                            className="w-full bg-slate-100 border-2 border-slate-200 rounded-xl px-4 py-4 mb-6 focus:outline-none focus:border-blue-400 text-center font-bold text-slate-700"
                            style={{ fontSize: `${fontSize}px` }}
                        />
                        <motion.button
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                            onClick={() => name.trim() && onStart(name)}
                            disabled={!name.trim()}
                            className={`w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all ${name.trim() ? 'bg-gradient-to-r from-blue-500 to-indigo-500 shadow-blue-300/50' : 'bg-gray-300 cursor-not-allowed'}`}
                            style={{ fontSize: `${fontSize * 1.1}px` }}
                        >
                            é–‹å§‹éŠæˆ² ğŸš€
                        </motion.button>
                    </div>
                </motion.div>
            );
        };

        // Dashboard (Level Selection)
        const Dashboard = ({ user, score, onSelectLevel, fontSize }) => {
            const levels = [
                { id: 'L1', title: 'åˆéšï¼šç°¡å–®åŠ æ³•', sub: '1+1=?', icon: 'ğŸ', color: 'bg-green-100 border-green-300 text-green-700' },
                { id: 'L2', title: 'ä¸­éšï¼šæ¹Šæˆå', sub: '2+8=?', icon: 'ğŸ‘', color: 'bg-yellow-100 border-yellow-300 text-yellow-800' },
                { id: 'L3', title: 'é«˜éšï¼šé€²ä½åŠ æ³•', sub: '9+9=?', icon: 'ğŸš€', color: 'bg-red-100 border-red-300 text-red-800' },
                { id: 'SELF', title: 'è‡ªå­¸æ¨¡å¼', sub: 'è‡ªå·±å‡ºé¡Œ', icon: 'ğŸ“', color: 'bg-purple-100 border-purple-300 text-purple-800' },
            ];

            return (
                <div className="p-4 max-w-4xl mx-auto pt-20">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="font-bold text-slate-700" style={{ fontSize: `${fontSize * 1.2}px` }}>å—¨ï¼Œ{user}ï¼</h2>
                            <p className="text-slate-500">ä»Šå¤©æƒ³æŒ‘æˆ°ä»€éº¼ï¼Ÿ</p>
                        </div>
                        <div className="bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-2">
                            <span className="text-2xl">ğŸ’°</span>
                            <span className="font-bold text-slate-700 text-xl">{score.tokens}</span>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {levels.map(lvl => (
                            <motion.button
                                key={lvl.id}
                                whileHover={{ scale: 1.02, y: -2 }}
                                whileTap={{ scale: 0.98 }}
                                onClick={() => onSelectLevel(lvl.id)}
                                className={`p-6 rounded-3xl border-b-4 text-left shadow-sm flex items-center gap-4 ${lvl.color}`}
                            >
                                <div className="text-4xl">{lvl.icon}</div>
                                <div>
                                    <div className="font-bold" style={{ fontSize: `${fontSize}px` }}>{lvl.title}</div>
                                    <div className="opacity-80 text-sm">{lvl.sub}</div>
                                </div>
                            </motion.button>
                        ))}
                    </div>
                    
                    {/* Report Button */}
                     <motion.button
                        whileTap={{ scale: 0.98 }}
                        onClick={() => onSelectLevel('REPORT')}
                        className="mt-8 w-full bg-white border-2 border-slate-200 rounded-2xl p-4 text-slate-600 font-bold flex items-center justify-center gap-2"
                    >
                        <Icons.User /> æŸ¥çœ‹æˆ‘çš„æˆå°±å ±å‘Š
                    </motion.button>
                </div>
            );
        };

        // Game Interface
        const GameInterface = ({ levelId, fontSize, speechRate, onBack, onComplete, onEarnToken }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [questions, setQuestions] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [feedback, setFeedback] = useState(null); // 'correct' | 'wrong' | null
            const [attempts, setAttempts] = useState(0); // Track wrong attempts per question
            const [totalWrong, setTotalWrong] = useState(0); // For grit score
            const [selfSetup, setSelfSetup] = useState(levelId === 'SELF'); // Is user setting up self question?
            const [selfVals, setSelfVals] = useState({x: '', y: ''});

            // Generate Questions based on logic
            useEffect(() => {
                if (levelId === 'SELF') return;

                let qList = [];
                for(let i=0; i<10; i++) {
                    let a, b, q, ans, opts;
                    if (levelId === 'L1') {
                        a = Math.floor(Math.random() * 5); // 0-4
                        b = Math.floor(Math.random() * 5); // 0-4
                        ans = a + b;
                        // Options: Correct, +1, -1, Random
                        let fake1 = ans + 1;
                        let fake2 = Math.max(0, ans - 1);
                        let fake3 = ans + 2;
                        opts = [ans, fake1, fake2, fake3].sort(() => Math.random() - 0.5);
                        qList.push({ q: `${a} + ${b}`, ans, a, b, opts, type: 'MCQ' });
                    } else if (levelId === 'L2') {
                        a = Math.floor(Math.random() * 9) + 1; // 1-9
                        b = 10 - a;
                        ans = 10;
                        opts = [10, 9, 11, 8].sort(() => Math.random() - 0.5);
                        qList.push({ q: `${a} + ${b}`, ans, a, b, opts, type: 'MCQ' });
                    } else if (levelId === 'L3') {
                        a = Math.floor(Math.random() * 5) + 5; // 5-9
                        b = Math.floor(Math.random() * 5) + 5; // 5-9
                        ans = a + b; // Result >= 10
                        qList.push({ q: `${a} + ${b}`, ans, a, b, type: 'INPUT' });
                    }
                }
                setQuestions(qList);
            }, [levelId]);

            const playSound = (type) => {
                // Simple synth simulation or placeholder
                // In a real app, use Audio() with assets
                if (type === 'correct') speak("ç­”å°äº†ï¼å¥½æ£’ï¼", speechRate);
                if (type === 'wrong') speak("å†è©¦ä¸€æ¬¡ï¼", speechRate);
            };

            const handleAnswer = (val) => {
                const currentQuestion = questions[currentQ];
                if (parseInt(val) === currentQuestion.ans) {
                    // Correct
                    setFeedback('correct');
                    playSound('correct');
                    setTimeout(() => {
                        onEarnToken(10 + attempts); // Score logic: Base + Effort tracking
                        
                        if (currentQ < questions.length - 1) {
                            setFeedback(null);
                            setCurrentQ(c => c + 1);
                            setUserInput("");
                            setAttempts(0);
                        } else {
                            onComplete(totalWrong + attempts); // Pass total errors for Grit calculation
                        }
                    }, 2000);
                } else {
                    // Wrong
                    setFeedback('wrong');
                    playSound('wrong');
                    setAttempts(prev => prev + 1);
                    setTotalWrong(prev => prev + 1);
                    
                    // Shake effect logic here visually via Framer Motion
                    setTimeout(() => setFeedback(null), 1500);
                }
            };

            const handleSelfSetup = () => {
                if(!selfVals.x || !selfVals.y) return;
                const a = parseInt(selfVals.x);
                const b = parseInt(selfVals.y);
                if(a+b > 20) {
                    speak("ç­”æ¡ˆä¸èƒ½å¤§æ–¼20å“¦", speechRate);
                    return;
                }
                setQuestions([{ q: `${a} + ${b}`, ans: a+b, a, b, type: 'INPUT' }]);
                setSelfSetup(false);
            };

            // Renders
            if (selfSetup) {
                return (
                    <div className="pt-20 px-4 max-w-md mx-auto text-center">
                         <h2 className="text-xl font-bold mb-4">è‡ªå·±å‡ºé¡Œè€ƒè€ƒè‡ªå·±ï¼</h2>
                         <div className="flex items-center justify-center gap-4 text-4xl font-bold mb-8">
                            <input type="number" className="w-20 p-2 rounded-xl text-center" value={selfVals.x} onChange={e=>setSelfVals({...selfVals, x:e.target.value})}/>
                            <span>+</span>
                            <input type="number" className="w-20 p-2 rounded-xl text-center" value={selfVals.y} onChange={e=>setSelfVals({...selfVals, y:e.target.value})}/>
                         </div>
                         <button onClick={handleSelfSetup} className="bg-blue-500 text-white px-8 py-3 rounded-xl font-bold text-xl">é–‹å§‹è§£ç­”</button>
                         <button onClick={onBack} className="block w-full mt-4 text-slate-400">å–æ¶ˆ</button>
                    </div>
                );
            }

            if (questions.length === 0) return <div className="pt-20 text-center">æº–å‚™ä¸­...</div>;

            const q = questions[currentQ];

            return (
                <div className="pt-20 px-4 h-full flex flex-col items-center">
                    {/* Progress */}
                    <div className="w-full max-w-md h-4 bg-gray-200 rounded-full mb-6 overflow-hidden">
                        <motion.div 
                            className="h-full bg-blue-400"
                            initial={{ width: 0 }}
                            animate={{ width: `${((currentQ) / questions.length) * 100}%` }}
                        />
                    </div>

                    {/* Question Card */}
                    <div className="bg-white/80 backdrop-blur rounded-3xl p-8 shadow-xl w-full max-w-md text-center border-4 border-white relative">
                         {/* TTS Button */}
                         <button 
                            onClick={() => speak(`${q.a}åŠ ${q.b}ç­‰æ–¼å¤šå°‘ï¼Ÿ`, speechRate, true)}
                            className="absolute top-4 right-4 text-blue-400 hover:scale-110 transition-transform"
                        >
                            <Icons.Volume2 size={32} />
                        </button>

                        <div className="flex justify-center items-center gap-4 mb-6">
                            <span className="font-bold text-slate-700" style={{ fontSize: `${fontSize * 2.5}px` }}>{q.q} = ?</span>
                        </div>

                        {/* Visual Aids */}
                        <div className="flex justify-center gap-8 mb-4">
                            <div className="grid grid-cols-5 gap-1 w-24 justify-items-center">
                                {[...Array(q.a)].map((_, i) => <div key={i} className="w-3 h-3 rounded-full bg-blue-500"></div>)}
                            </div>
                            <div className="grid grid-cols-5 gap-1 w-24 justify-items-center">
                                {[...Array(q.b)].map((_, i) => <div key={i} className="w-3 h-3 rounded-full bg-green-500"></div>)}
                            </div>
                        </div>

                        {/* Feedback Overlay */}
                        <AnimatePresence>
                            {feedback && (
                                <motion.div 
                                    initial={{ scale: 0, opacity: 0 }}
                                    animate={{ scale: 1, opacity: 1 }}
                                    exit={{ scale: 0, opacity: 0 }}
                                    className="absolute inset-0 z-10 flex items-center justify-center rounded-2xl bg-white/90"
                                >
                                    {feedback === 'correct' ? (
                                        <div className="text-center">
                                            <div className="text-6xl mb-2">ğŸ‰</div>
                                            <div className="text-green-600 font-bold text-2xl">ç­”å°äº†ï¼</div>
                                        </div>
                                    ) : (
                                        <div className="text-center">
                                            <div className="text-6xl mb-2">ğŸ¤”</div>
                                            <div className="text-orange-500 font-bold text-2xl">å†è©¦ä¸€æ¬¡ï¼</div>
                                            {attempts >= 1 && <div className="text-sm text-slate-500 mt-2">æç¤ºï¼šå¯ä»¥ç”¨æ‰‹æŒ‡æ•¸æ•¸çœ‹é»é»å“¦</div>}
                                        </div>
                                    )}
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>

                    {/* Input Area */}
                    <div className="w-full max-w-md mt-6 flex-grow">
                        {q.type === 'MCQ' ? (
                            <div className="grid grid-cols-2 gap-4">
                                {q.opts.map((opt, idx) => (
                                    <motion.button
                                        key={idx}
                                        whileTap={{ scale: 0.95 }}
                                        onClick={() => handleAnswer(opt)}
                                        className="h-24 bg-white rounded-2xl shadow-sm border-b-4 border-slate-200 font-bold text-slate-700 hover:bg-blue-50 hover:border-blue-200 transition-colors"
                                        style={{ fontSize: `${fontSize * 1.5}px` }}
                                    >
                                        {opt}
                                    </motion.button>
                                ))}
                            </div>
                        ) : (
                            <div>
                                <div className="bg-white p-4 rounded-xl text-center mb-2 border-2 border-slate-200 min-h-[4rem] flex items-center justify-center">
                                    <span className="font-bold text-slate-800" style={{ fontSize: `${fontSize * 1.5}px` }}>
                                        {userInput || "_"}
                                    </span>
                                </div>
                                <CustomKeypad 
                                    onInput={(n) => setUserInput(prev => (prev.length < 2 ? prev + n : prev))}
                                    onDelete={() => setUserInput(prev => prev.slice(0, -1))}
                                    onSubmit={() => userInput && handleAnswer(userInput)}
                                    disabled={feedback !== null}
                                />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. Claw Machine Game
        const ClawMachine = ({ user, score, onPlayEnd, fontSize }) => {
            // Logic: 3rd try guarantee.
            // We simulate this by checking score.tries % 3
            // 0: Drop halfway
            // 1: Drop at rim
            // 2: Success
            
            const [status, setStatus] = useState('IDLE'); // IDLE, MOVING, DROPPING, RESULT
            const [clawX, setClawX] = useState(0);
            const [resultMsg, setResultMsg] = useState("");
            
            // Random prize list
            const prizes = [
                { name: "æš–æš–æ¯", icon: "ğŸµ", desc: "çµ¦åª½åª½æš–æš–èº«" },
                { name: "æŒ‰æ‘©æ§Œ", icon: "ğŸ”¨", desc: "å¹«çˆ¸çˆ¸æ¥èƒŒ" },
                { name: "æ„›å¿ƒä¾¿ç•¶", icon: "ğŸ±", desc: "å®¶äººåƒå¾—é£½" },
                { name: "å¤§æ“æŠ±", icon: "ğŸ¤—", desc: "å…è²»çš„æ„›" }
            ];

            const play = () => {
                if (status !== 'IDLE') return;
                setStatus('MOVING');

                // Determine outcome based on a mock "attempts" counter logic
                // For this demo, let's use a randomizer that favors success heavily for demo purposes
                // Or follow strict rule: 3rd time success.
                // Let's create a local storage or state based attempt counter in parent, but here we mock:
                const attempt = (score.clawAttempts || 0) % 3;
                const isWin = attempt === 2; 

                // Animation Sequence
                setTimeout(() => {
                    setStatus('DROPPING');
                    setTimeout(() => {
                        if (isWin) {
                            setStatus('RESULT');
                            const prize = prizes[Math.floor(Math.random() * prizes.length)];
                            setResultMsg(prize);
                            setTimeout(() => onPlayEnd(true, prize), 3000);
                        } else {
                            setStatus('IDLE');
                            // Determine fail message based on attempt
                            const failMsg = attempt === 0 ? "å“å‘€ï¼æ»‘æ‰äº†ï¼" : "å·®ä¸€é»é»ï¼ä¸‹æ¬¡ä¸€å®šä¸­ï¼";
                            speak(failMsg);
                            onPlayEnd(false, null); // Consume token, no prize
                        }
                    }, 1500);
                }, 2000);
            };

            return (
                <div className="pt-20 px-4 h-full flex flex-col items-center justify-between pb-8">
                     <div className="bg-white/50 px-6 py-2 rounded-full mb-4">
                        <span className="font-bold text-slate-700">å‰©é¤˜ä»£å¹£: {score.tokens}</span>
                    </div>

                    {/* Machine UI */}
                    <div className="relative w-full max-w-md h-[50vh] bg-pink-100 rounded-t-3xl border-4 border-pink-300 overflow-hidden shadow-2xl">
                        {/* Glass */}
                        <div className="absolute inset-0 bg-blue-100/20 z-10 pointer-events-none border-b-8 border-pink-200"></div>
                        
                        {/* Claw Track */}
                        <div className="absolute top-0 left-0 right-0 h-4 bg-gray-300 z-0"></div>
                        
                        {/* The Claw */}
                        <motion.div 
                            className="absolute top-0 left-1/2 w-2 h-20 bg-gray-400 z-0 origin-top"
                            animate={{ 
                                x: status === 'MOVING' ? [0, -100, 100, 0] : 0,
                                height: status === 'DROPPING' ? 250 : 80
                            }}
                            transition={{ duration: status === 'MOVING' ? 2 : 1 }}
                        >
                            <div className="absolute bottom-0 -left-6 w-14 h-10 border-4 border-gray-600 rounded-b-full"></div>
                        </motion.div>

                        {/* Prizes at bottom */}
                        <div className="absolute bottom-0 left-0 right-0 h-32 flex items-end justify-around p-4">
                             {prizes.map((p, i) => (
                                 <motion.div key={i} className="text-5xl" animate={{ y: [0, -5, 0] }} transition={{ repeat: Infinity, duration: 2, delay: i * 0.5 }}>
                                     {p.icon}
                                 </motion.div>
                             ))}
                        </div>
                        
                        {/* Prize Drop / Result Overlay */}
                        <AnimatePresence>
                            {status === 'RESULT' && resultMsg && (
                                <motion.div 
                                    initial={{ scale: 0 }} animate={{ scale: 1 }}
                                    className="absolute inset-0 z-20 flex items-center justify-center bg-black/50"
                                >
                                    <div className="bg-white p-6 rounded-2xl text-center animate-bounce">
                                        <div className="text-6xl mb-2">{resultMsg.icon}</div>
                                        <h3 className="text-xl font-bold text-pink-500">å¤¾åˆ°äº†ï¼</h3>
                                        <p className="text-slate-600">{resultMsg.name}</p>
                                        <p className="text-xs text-gray-400 mt-2">({resultMsg.desc})</p>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>
                    
                    {/* Controls */}
                    <div className="w-full max-w-md bg-pink-500 p-6 rounded-b-3xl shadow-xl flex justify-center relative">
                        {/* Coin slot decoration */}
                        <div className="absolute left-6 top-8 w-8 h-12 bg-gray-800 rounded-md border-2 border-gray-600"></div>

                        <button 
                            onClick={play}
                            disabled={status !== 'IDLE' || score.tokens <= 0}
                            className={`w-24 h-24 rounded-full border-b-8 shadow-xl flex items-center justify-center transition-transform active:scale-95 ${score.tokens > 0 ? 'bg-yellow-400 border-yellow-600' : 'bg-gray-400 border-gray-600'}`}
                        >
                            <span className="font-bold text-yellow-900 text-xl">GRAB!</span>
                        </button>
                    </div>
                    
                    <button onClick={() => onPlayEnd(false)} className="mt-4 text-slate-500 underline">è¿”å›</button>
                </div>
            );
        };

        // 5. Report Screen
        const ReportScreen = ({ score, onRestart, fontSize }) => {
            // Logic: Total Score = (Correct * 10) + (Errors * 1)
            // Assuming we pass raw data or calculated in parent. 
            // For this demo, let's assume 'score.points' includes the logic, 
            // and we track 'score.errors' separately.
            
            // Reconstruct visuals based on prompt
            const totalScore = (score.correct * 10) + (score.errors * 1);

            return (
                <div className="pt-20 px-4 max-w-2xl mx-auto pb-20">
                    <div className="text-center mb-8">
                         <div className="inline-block p-4 bg-yellow-100 rounded-full mb-4">
                            <Icons.Star size={48} className="text-yellow-500" />
                         </div>
                         <h2 className="text-3xl font-bold text-slate-800 mb-2">å¥½æ£’ï¼å®Œæˆä»»å‹™ï¼</h2>
                         <p className="text-slate-500">çœ‹çœ‹ä½ çš„å­¸ç¿’æˆæœ</p>
                    </div>

                    <div className="bg-white rounded-3xl shadow-xl overflow-hidden mb-6">
                        <div className="bg-blue-600 p-6 text-white text-center">
                            <div className="text-sm opacity-80">ç¸½æˆå°±åˆ†</div>
                            <div className="text-6xl font-bold">{totalScore}</div>
                        </div>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4 border-b pb-4">
                                <div className="flex items-center gap-2">
                                    <div className="p-2 bg-green-100 rounded-lg text-green-600"><Icons.Check /></div>
                                    <span className="font-bold text-slate-700">èƒ½åŠ›å¾—åˆ†</span>
                                </div>
                                <span className="font-bold text-green-600">{score.correct * 10} åˆ†</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <div className="p-2 bg-orange-100 rounded-lg text-orange-600"><Icons.RefreshCw /></div>
                                    <div>
                                        <span className="font-bold text-slate-700">åŠªåŠ›å˜—è©¦</span>
                                        <div className="text-xs text-slate-400">æ¯ä¸€æ¬¡éŒ¯èª¤éƒ½æ˜¯å­¸ç¿’çš„æ©Ÿæœƒï¼</div>
                                    </div>
                                </div>
                                <span className="font-bold text-orange-600">+ {score.errors} åˆ†</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm p-6 mb-6 border border-slate-100">
                        <h3 className="font-bold text-slate-700 mb-4">çµ¦å°å°ˆå®¶çš„å»ºè­° ğŸ’¡</h3>
                        <ul className="space-y-3">
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸš€</span>
                                <span className="text-slate-600">ä½ ä»Šå¤©å¾ˆæ£’ï¼Œç‰¹åˆ¥æ˜¯å …æŒå®Œæˆäº†æŒ‘æˆ°ï¼</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ§©</span>
                                <span className="text-slate-600">å¯ä»¥è©¦è‘—ç·´ç¿’ã€Œ9çš„é€²ä½ã€ï¼Œå°±åƒæ­ç©æœ¨ä¸€æ¨£ç°¡å–®ï¼</span>
                            </li>
                        </ul>
                    </div>
                    
                    <h3 className="font-bold text-slate-700 mb-4">ä½ çš„æˆ°åˆ©å“ ğŸ</h3>
                    <div className="grid grid-cols-2 gap-4 mb-8">
                        {score.gifts.length > 0 ? score.gifts.map((g, i) => (
                            <div key={i} className="bg-pink-50 p-4 rounded-xl flex items-center gap-3 border border-pink-100">
                                <span className="text-3xl">{g.icon}</span>
                                <div>
                                    <div className="font-bold text-slate-700">{g.name}</div>
                                    <div className="text-xs text-pink-400">çµ¦å®¶äººçš„ç¦®ç‰©</div>
                                </div>
                            </div>
                        )) : (
                            <div className="col-span-2 text-center text-gray-400 py-4 bg-gray-50 rounded-xl">é‚„æ²’å¤¾åˆ°ç¦®ç‰©ï¼Œå†å»è©¦è©¦ï¼</div>
                        )}
                    </div>

                    <button 
                        onClick={onRestart}
                        className="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-700 transition-colors"
                    >
                        å›åˆ°é¦–é 
                    </button>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            // State
            const [view, setView] = useState('WELCOME'); // WELCOME, DASHBOARD, GAME, CLAW, REPORT
            const [settings, setSettings] = useState({ fontSizeIdx: 2, speechRateIdx: 5, soundOn: true }); // Default idx 2 (18px), 5 (1.0x)
            const [user, setUser] = useState({ name: "" });
            const [gameState, setGameState] = useState({
                level: null,
                tokens: 0,
                correct: 0,
                errors: 0,
                clawAttempts: 0,
                gifts: []
            });

            // Derived Settings
            const fontSize = [14, 16, 18, 22, 26, 32][settings.fontSizeIdx];
            const speechRate = [0.5, 0.6, 0.7, 0.8, 0.9, 1.0][settings.speechRateIdx];

            useEffect(() => {
                lucide.createIcons();
            }, [view]);

            // Handlers
            const startGame = (name) => {
                setUser({ name });
                setView('DASHBOARD');
            };

            const selectLevel = (lvlId) => {
                if(lvlId === 'REPORT') {
                    setView('REPORT');
                } else {
                    setGameState(prev => ({ ...prev, level: lvlId }));
                    setView('GAME');
                }
            };

            const handleTokenEarned = (pointsToAdd) => {
                // pointsToAdd logic handled inside GameInterface visual score, 
                // here we just add token and track global stats
                setGameState(prev => ({
                    ...prev,
                    tokens: prev.tokens + 1,
                    correct: prev.correct + 1 // Simply counting correct Qs
                }));
            };

            const handleGameComplete = (sessionErrors) => {
                 setGameState(prev => ({
                    ...prev,
                    errors: prev.errors + sessionErrors
                }));
                // Go to claw machine if tokens > 0, else Dashboard
                setTimeout(() => {
                    if (gameState.tokens > 0) {
                         // Prompt user: Go to claw? For flow simplicity, let's go Dashboard
                         // Or show a modal. Let's go Dashboard to let them choose.
                         setView('DASHBOARD');
                    } else {
                         setView('DASHBOARD');
                    }
                }, 500);
            };

            const enterClaw = () => {
                setView('CLAW');
            };

            const handleClawEnd = (success, prize) => {
                setGameState(prev => ({
                    ...prev,
                    tokens: Math.max(0, prev.tokens - 1),
                    clawAttempts: prev.clawAttempts + 1,
                    gifts: success ? [...prev.gifts, prize] : prev.gifts
                }));
                if(success) {
                    speak(`æ­å–œï¼ä½ å¤¾åˆ°äº†${prize.name}`, speechRate);
                }
            };

            // Floating Action Button
            const FAB = () => (
                <div className="fixed bottom-4 right-4 z-50 holographic text-slate-800 px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 cursor-pointer hover:scale-105 transition-transform">
                    <Icons.Computer size={14} />
                    <span>WMC ç¨‹è€å¸« è¨­è¨ˆ</span>
                </div>
            );

            // Footer
            const Footer = () => (
                <footer className="w-full text-center py-4 text-slate-400 text-xs mt-auto">
                    Â©2025 WMC
                </footer>
            );

            // Global Back Button (except Welcome)
            const BackBtn = () => (
                view !== 'WELCOME' && (
                    <button 
                        onClick={() => setView('DASHBOARD')} 
                        className="fixed top-4 left-4 z-40 bg-white/80 backdrop-blur p-2 rounded-xl shadow-sm border border-slate-200 text-slate-600 hover:bg-slate-100"
                    >
                        <Icons.Home />
                    </button>
                )
            );

            // Token Widget (Clickable to go to Claw)
            const TokenWidget = () => (
                view === 'DASHBOARD' && gameState.tokens > 0 && (
                    <motion.button 
                        initial={{ scale: 0 }} animate={{ scale: 1 }}
                        className="fixed bottom-20 right-4 z-40 bg-pink-500 text-white p-4 rounded-full shadow-xl border-4 border-white flex items-center justify-center gap-2 animate-bounce"
                        onClick={enterClaw}
                    >
                        <Icons.Gift />
                        <span className="font-bold">å»å¤¾å…¬ä»”!</span>
                        <span className="bg-white text-pink-500 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{gameState.tokens}</span>
                    </motion.button>
                )
            );

            return (
                <div className="min-h-screen flex flex-col relative bg-yellow-50/50">
                    <SettingsModule settings={settings} setSettings={setSettings} />
                    <BackBtn />
                    
                    <main className="flex-grow">
                        <AnimatePresence mode="wait">
                            {view === 'WELCOME' && (
                                <motion.div key="welcome" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}>
                                    <WelcomeScreen onStart={startGame} fontSize={fontSize} />
                                </motion.div>
                            )}
                            {view === 'DASHBOARD' && (
                                <motion.div key="dash" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}>
                                    <Dashboard user={user.name} score={gameState} onSelectLevel={selectLevel} fontSize={fontSize} />
                                </motion.div>
                            )}
                            {view === 'GAME' && (
                                <motion.div key="game" initial={{x:300, opacity:0}} animate={{x:0, opacity:1}} exit={{x:-300, opacity:0}} className="h-screen">
                                    <GameInterface 
                                        levelId={gameState.level} 
                                        fontSize={fontSize} 
                                        speechRate={speechRate}
                                        onBack={() => setView('DASHBOARD')}
                                        onEarnToken={handleTokenEarned}
                                        onComplete={handleGameComplete}
                                    />
                                </motion.div>
                            )}
                            {view === 'CLAW' && (
                                <motion.div key="claw" initial={{y:500, opacity:0}} animate={{y:0, opacity:1}} exit={{y:500, opacity:0}} className="h-screen">
                                    <ClawMachine 
                                        user={user.name} 
                                        score={gameState} 
                                        onPlayEnd={handleClawEnd} 
                                        fontSize={fontSize} 
                                    />
                                </motion.div>
                            )}
                            {view === 'REPORT' && (
                                <motion.div key="report" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}>
                                    <ReportScreen score={gameState} onRestart={() => setView('DASHBOARD')} fontSize={fontSize} />
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </main>

                    <TokenWidget />
                    <FAB />
                    <Footer />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>